<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" th:href="@{/css/cart_styles.css}">
    <script src="js/cart.js" defer></script>
</head>
<body>
<div class="cart-container">
    <h1>장바구니</h1>
    <div class="cart-items" th:each="cartItem : ${cartItems}">
        <div class="cart-item" th:object="${cartItem}" data-id=${cartItem.product.id} data-price=${cartItem.product.price}>
            <img th:src="@{${cartItem.product.imagePath}}" alt="Product Image" class="product-image">
            <span class="item-name" th:text="*{product.name}">상품명</span>
            <span th:text="${#numbers.formatInteger(cartItem.product.price, 3, 'COMMA')} + '원'">가격</span>
            <div class="item-quantity">
                <button type="button" th:attr="data-id=${cartItem.product.id}" class="decrease-button">-</button>
                <span class="quantity" th:text="*{quantity}">1</span>
                <button type="button" th:attr="data-id=${cartItem.product.id}" class="increase-button">+</button>
            </div>
            <button type="button" class="remove-item-btn" onclick="removeItem(${cartItem.product.id})">제거</button>
        </div>
    </div>
    <div class="cart-summary">
        <span class="summary-total-label">총합계:</span>
        <span class="summary-total-amount" th:text="${#numbers.formatInteger(cartTotal, 3, 'COMMA')} + '원'">합계 금액</span>
    </div>
</div>
</body>
</html>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        updateTotal(); // Initial total update
        attachEventListeners(); // Attach the event listeners to buttons
    });

    function attachEventListeners() {
        // Attach event listeners to all plus and minus buttons
        document.querySelectorAll('.increase-button').forEach(button => {
            button.addEventListener('click', () => {
                console.log('Increase button clicked for item ID:', button.dataset.id);
                updateQuantity(button.dataset.id, 1);
            });
        });

        document.querySelectorAll('.decrease-button').forEach(button => {
            button.addEventListener('click', () => {
                console.log('Decrease button clicked for item ID:', button.dataset.id);
                updateQuantity(button.dataset.id, -1);
            });
        });
    }

    function updateQuantity(itemId, change) {
        // Update the quantity of the item
        const item = document.querySelector(`.cart-item[data-id=${itemId}]`);
        if (!item) {
            console.error('Item with ID not found:', itemId);
            return;
        }
        const quantityElement = item.querySelector('.quantity');
        let quantity = parseInt(quantityElement.textContent, 10);
        quantity = Math.max(quantity + change, 0); // Prevent negative quantities
        quantityElement.textContent = quantity;

        // Prepare the data to send in the POST request
        let formData = new FormData();
        formData.append("id", itemId);
        formData.append("change", change);

        // Make the POST request to the server
        fetch('/cart/update', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            // Handle the response from the server
            console.log('Quantity updated', data);
            updateTotal(); // Update the total price display
        }).catch(error => {
            console.error('Error updating quantity:', error);
        });

        updateTotal(); // Update the total price display
    }

    function updateTotal() {
        //Calculate the total price
        let total = 0;
        document.querySelectorAll('.cart-item').forEach(item => {
            const price = parseInt(item.dataset.price, 10); // Assuming price is stored in data-price
            const quantity = parseInt(item.querySelector('.quantity').textContent, 10);
            total += price * quantity;
        });

        // Update the total price display
        document.querySelector('.summary-total-amount').textContent = `${total.toLocaleString()}원`;
    }

</script>